# 直方图处理
## 定义
灰度级范围为 $\left [ 0,L-1 \right ]$ 的数字图像的直方图是离散函数 $h\left ( r_{k}  \right ) =n_{k}$，其中 $r_{k}$ 是第 $k$ 级灰度值，$n_{k}$ 是图像中灰度为 $r_{k}$ 的像素个数。实践中，经常除以图像像素总数来归一化直方图。简单来说，直方图是对应灰度级在图像中出现概率的一个估计，归一化直方图的所有分量之和应等于 1。

一般来说，暗图像的直方图分量集中在灰度级的低端，亮图像的直方图分量集中在灰度级的高端；低对比度图像具有较窄的直方图，且集中于直方图的中部，而高对比度图像的直方图则覆盖了较宽的灰度级范围，且像素分布不会太不均匀。直观上，若一幅图像的像素倾向于占据整个可能的灰度级并且分布均匀，则该图像会具有较高的对比度并展示灰度的较大变化，最终效果就会是一幅灰度细节丰富且动态范围较大的图像。

这也是下面直方图均衡的理论基础。
## 直方图均衡
直方图均衡的理论基础就是对输入图像进行一个变换，使得变换后图像的直方图在整个灰度级上均匀分布。

假设有如下变换
$$
s=T\left ( r \right ) ,0\le r\le L-1
$$
其中 $r$ 和 $s$ 分别为输入和输出图像，按照上面的先验，$s$ 在直方图上应该占满整个灰度级并且每个灰度级都分布均匀，从概率论的角度来说就是 $s$ 的概率密度函数（PDF）应该是一个均匀分布，即：
$$
p_{s} \left ( s \right ) =\frac{1}{L-1} 
$$
由于 $s$ 的 PDF 函数又可以表示如下：
$$
p_{s} \left ( s \right ) =p_{r} \left ( r \right ) \left | \frac{dr}{ds}  \right | 
$$
我们便可以得到变换函数 $T$ 的微分函数为：
$$
\frac{ds}{dr} =\frac{dT\left ( r \right ) }{dr} =\left (  L-1\right ) p_{r} \left ( r \right ) 
$$
相应的，对上式积分就可得到我们需要的变换 $T$ 为：
$$
s=T\left ( r \right )=\left ( L-1 \right ) \int_{0}^{r} p_{r} \left ( w \right ) dw
$$
其中，$w$ 是积分的伪变量，公式右边是随机变量 $r$ 的累积分布函数（CDF），而这个我们完全可以从原图中统计得到。

由于我们处理的数字图像是离散值，所以我们处理其概率（直方图值）和求和来替代处理上面的概率密度函数与积分。如前面提到的，数字图像中灰度级 $r_{k}$ 出现的概率近似为
$$
p_{k} \left ( r_{k}  \right ) =\frac{n_{k} }{MN} ,k=0,1,2,...,L-1
$$
其中，$MN$ 是图像中的像素数量，$n_{k}$ 是灰度为 $r_{k}$ 的像素数，$L$ 是图像中可能的灰度级的数量（对于一般的 8 位图像来说就是 256），上式画出来的图形就是直方图。

那么上面提到的直方图均衡的离散形式即为
$$
s_{k}=T\left ( r_{k}  \right )  =\left ( L-1 \right ) \sum_{j=0}^{k} p_{r} \left ( r_{j}  \right )=\frac{L-1}{MN}\sum_{j=0}^{k}n_{j},k=0,1,2,...,L-1
$$

以上就是直方图均衡化的推理过程，它的优点是实现简单并且能自动确定变换函数，但在某些应用上并不是最好的选择。
## 直方图匹配（规定化）
直方图匹配是直方图均衡（和一张灰度级均匀分布的图像进行匹配）的推广形式，它可以让我们指定变换后的直方图分布。

假设现在有两张图像 $r$ 和 $z$，概率密度函数分别为 $p_{r}(r)$ 和 $p_{z}(z)$，将图像 $r$ 的 PDF 函数往 $z$ 上拟合，这就是直方图匹配。

有了直方图均衡的基础后，做法就比较直观了，我们可以通过直方图均衡的方法，求出 $r$ 到 $s$ 和 $z$ 到 $s$ 的映射关系，对于数字图像来说就是两张查找表。

具体的做法如下：

1. 求出图像 $r$ 的累计分布函数 $cdf_{r}$;
2. 求出图像 $z$ 的累计分布函数 $cdf_{z}$;
3. 用 $cdf_{r}$ 往 $cdf_{z}$ 去做匹配，这个过程中由于 $cdf_{z}$ 未必是一个严格的单调递增函数，所以实际匹配的时候会有一个输入对应多个输出的情况，这时候我们只需要取最小的那个值就可以了；
4. 对图像中的所有像素逐一映射，我们就得到了直方图匹配之后的图像

## 局部直方图处理
## 在图像增强中使用直方图统计